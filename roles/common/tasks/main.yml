---

#
# NTP
#

- name: set timezone
  template: src=timezone.j2 dest=/etc/timezone owner=root group=root mode=0644
  register: timezone

- name: reconfigure tzdata
  command: dpkg-reconfigure --frontend noninteractive tzdata
  when: timezone.changed

- name: stop ntpd
  service: name=ntp state=stopped
  when: timezone.changed

- name: set time with ntpdate
  command: "ntpdate -s ntp.ubuntu.com"
  when: timezone.changed

- name: start ntpd
  service: name=ntp state=started
  when: timezone.changed

#
# Packages
#

- name: setup apt-cacher-ng proxy
  template: src=01proxy.j2 dest=/etc/apt/apt.conf.d/01proxy

# XXX shoudl be using apt_key here I think instead of ubuntu-cloud-keyring XX
- name: install required packages to add havana repository
  apt: name=$item state=installed update_cache=yes #cache_valid_time=3600
  with_items:
    - ubuntu-cloud-keyring
    - python-pycurl
    - ntp

# XXX Not working; using ubuntu-cloud-keyring package instead
#- name: install havana apt key
#  apt_key: url=http://ubuntu-cloud.archive.canonical.com/ubuntu/dists/precise-updates/havana/Release.gpg 

- name: install havana apt repository
  apt_repository: repo='deb http://ubuntu-cloud.archive.canonical.com/ubuntu precise-updates/havana main' state=present
  register: new_repo

- name: update apt 
  command: apt-get update
  when: new_repo.changed

